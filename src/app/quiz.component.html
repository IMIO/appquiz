<div class="joueur-bg">
<!-- Interface joueur harmonisée avec le style maître du jeu -->
<div *ngIf="isLoading" class="loading-bar">
  <div class="loading-progress"></div>
  <span class="loading-text">{{ loadingMessage }}</span>
</div>

<!-- Étapes simplifiées -->
<div *ngIf="step === 'lobby'" class="player-step-banner lobby">
  <b>🎮 WAITING FOR GAME</b><br>
  <span>Registration and waiting for host validation</span>
</div>

<div *ngIf="step === 'waiting'" class="player-step-banner waiting">
  <b>⏳ READY TO START</b><br>
  <span>Registration closed, waiting for host to start</span>
</div>

<div *ngIf="!quizFinished && currentQuestion" class="quiz-container">
  <!-- Score banner harmonisé -->
  <div class="score-banner">
    <img *ngIf="avatarUrl" [src]="avatarUrl" alt="avatar" class="avatar" />
    <span *ngIf="!avatarUrl" class="avatar">👤</span>
    <span class="score-label">{{ userName || 'My' }} Score:</span>
    <span class="score-value">{{ totalScore }} / {{ totalQuestions }} pts</span>
  </div>

  <!-- Feedback de la dernière réponse -->
  <div class="score-detail" *ngIf="personalScore">
    <span *ngIf="personalScore.good" class="score-good">✅ Correct answer!</span>
    <span *ngIf="personalScore.bad" class="score-bad">❌ Wrong answer</span>
    <span *ngIf="personalScore.none" class="score-none">⏱️ No answer</span>
  </div>

  <!-- Bannière d'étape question masquée -->
  <!-- <div *ngIf="step === 'question'" class="player-step-banner question">
    <b>❓ QUESTION</b><br>
    <span>Answer before time runs out!</span>
  </div> -->

  <!-- Titre de la question avec numéro -->
  <div class="question-header">
    <div class="question-number">Question Numéro {{ currentQuestionNumber }}</div>
    <h2 class="question-title">{{ currentQuestion.text }}</h2>
  </div>

  <!-- Timer unifié - Toujours visible pendant les questions -->
  <div class="timer step-timer" *ngIf="step === 'question' || (currentQuestion && step !== 'result')">
    <div class="timer-bar-container" [ngClass]="{'timer-active': timerActive && questionStartTime > 0, 'timer-waiting': !timerActive || questionStartTime <= 0}">
      <div class="timer-bar" 
           [ngStyle]="{width: questionStartTime > 0 ? (timerValue / timerMax * 100) + '%' : '100%'}"
           [ngClass]="{'timer-bar-active': timerActive && questionStartTime > 0}"></div>
      <span class="timer-bar-label" [ngClass]="{'timer-active': timerActive && questionStartTime > 0}">
        <span *ngIf="timerActive && questionStartTime > 0">{{ timerValue }}s</span>
        <span *ngIf="questionStartTime > 0 && !timerActive">Timer stopped</span>
      </span>
    </div>
    
    <!-- Message unifié d'attente pour les joueurs -->
    <div *ngIf="questionStartTime <= 0" style="margin-top: 10px; padding: 12px; border-radius: 6px; font-size: 0.95em; color: #000; text-align: center; background-color: #FFF3E0; border: 1px solid #FFE0B2;">
      ⏳  Waiting for the host to start the timer...<br>
      <small style="opacity: 0.8; margin-top: 4px; display: block;">Answers will be activated once the timer starts</small>
    </div>
    
    <!-- Message indiquant que le timer est actif -->
    <div *ngIf="questionStartTime > 0 && timerActive" style="margin-top: 10px; padding: 12px; border-radius: 6px; font-size: 0.95em; color: #000; text-align: center; background-color: #E8F5E9; border: 1px solid #C8E6C9;">
      ✅ Timer active - You can now select an answer
    </div>
    
  </div>

        <!-- Options de réponses -->
  <ul class="options-list">
    <li *ngFor="let option of currentQuestion.options; let i = index">
      <button
        class="option-btn"
        (click)="selectAnswer(i)"
        [disabled]="!canPlay || activeStep === 'result'"
        [class.option-correct]="(activeStep === 'result' || activeStep === 'waiting') && i === currentQuestion.correctIndex"
        [class.option-incorrect]="(activeStep === 'result' || activeStep === 'waiting') && selectedAnswerIndex === i && i !== currentQuestion.correctIndex"
        [class.option-selected]="selectedAnswerIndex === i && isQuestionOrResultStep"
        [class.option-selectable]="canPlay && activeStep === 'question'"
      >
        <!-- Indicateur de sélection actuelle avec meilleur contraste -->
        <span *ngIf="selectedAnswerIndex === i && isQuestionOrResultStep" class="option-selected-icon" 
              style="background-color: rgba(8, 176, 236, 0.2); padding: 2px 4px; border-radius: 3px; margin-right: 5px;">👉</span>
        
        <!-- Contenu de l'option -->
        <ng-container *ngIf="option?.text !== undefined; else stringOption">
          {{ option.text }}
        </ng-container>
        <ng-template #stringOption>{{ option }}</ng-template>
        
        <!-- Indicateurs de résultat avec meilleur contraste -->
        <span *ngIf="(activeStep === 'result' || activeStep === 'waiting') && i === currentQuestion.correctIndex" 
              style="margin-left: auto; color: #2e7d32; font-weight: bold; background-color: rgba(76, 175, 80, 0.2); padding: 2px 6px; border-radius: 4px;">✓</span>
        <span *ngIf="(activeStep === 'result' || activeStep === 'waiting') && selectedAnswerIndex === i && i !== currentQuestion.correctIndex" 
              style="margin-left: auto; color: #c62828; font-weight: bold; background-color: rgba(244, 67, 54, 0.2); padding: 2px 6px; border-radius: 4px;">✗</span>
              
        <!-- Indicateur que le bouton est sélectionnable avec meilleur contraste -->
        <span *ngIf="canPlay && activeStep === 'question' && selectedAnswerIndex !== i" 
              class="selectable-indicator" 
              style="position: absolute; right: 10px; font-size: 0.9em; color: #08B0EC; font-weight: bold;">⮚</span>
      </button>
    </li>
  </ul>

  <!-- Résultat avec informations détaillées -->
  <div *ngIf="activeStep === 'result'" class="result-section">
    <!-- Affichage du résultat de la réponse du joueur -->
    <div class="player-result-banner">
      <div *ngIf="selectedAnswerIndex !== null && selectedAnswerIndex >= 0" class="answer-feedback">
        <div *ngIf="isAnswerCorrect" class="correct-feedback">
          ✅ <strong>Well done !</strong>
        </div>
        <div *ngIf="isAnswerCorrect === false" class="incorrect-feedback">
          ❌ <strong>Incorrect answer</strong>
        </div>
      </div>
      <div *ngIf="selectedAnswerIndex === null || selectedAnswerIndex < 0" class="no-answer-feedback">
        ⏰ <strong>Time's up - No answer</strong>
      </div>
    </div>
    
    <!-- Affichage de la bonne réponse -->
    <div class="correct-answer-display">
      <h4>💡 The answer was :</h4>
      <div class="correct-answer-text" *ngIf="currentQuestion && currentQuestion.correctIndex !== undefined">
        <ng-container *ngIf="currentQuestion.options[currentQuestion.correctIndex]?.text !== undefined; else stringCorrectOption">
          {{ currentQuestion.options[currentQuestion.correctIndex].text }}
        </ng-container>
        <ng-template #stringCorrectOption>{{ currentQuestion.options[currentQuestion.correctIndex] }}</ng-template>
      </div>
    </div>
    
    <div class="player-step-banner result">
      <b>📊 Results</b><br>
      <span>Waiting for the next question...</span>
    </div>
  </div>
</div>

<!-- Quiz terminé (style harmonisé) -->
<div *ngIf="quizFinished" class="quiz-finished-container">
  <h2>🏁 Quiz Completed!</h2>
  
  <!-- Score final -->
  <div class="score-banner">
    <img *ngIf="avatarUrl" [src]="avatarUrl" alt="avatar" class="avatar" />
    <span *ngIf="!avatarUrl" class="avatar">👤</span>
    <span class="score-label">Final Score:</span>
    <span class="score-value">{{ totalScore }} / {{ totalQuestions }} pts</span>
  </div>

  <!-- Leaderboard final -->
  <h3 style="margin-top: 2em; color: #232526;">🏆 Final Ranking</h3>
  <ol class="joueur-leaderboard-list">
    <li *ngFor="let user of leaderboard; let i = index" class="joueur-leaderboard-item">
      <span class="joueur-leaderboard-rank">{{ i + 1 }}</span>
      <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="avatar" width="32" height="32" style="border-radius: 50%; border: 2px solid #1976d2;" />
      <span style="font-weight: bold;">{{ user.name }}</span>
      <span style="margin-left: auto; font-weight: bold; color: #232526;">{{ user.score }} / {{ totalQuestions }} pts</span>
    </li>
  </ol>
</div>
</div>
