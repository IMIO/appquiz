<div *ngIf="!quizFinished && currentQuestion" class="quiz-container">
  <div class="participant-score-banner">
    <img *ngIf="avatarUrl" [src]="avatarUrl" alt="avatar" class="participant-avatar" />
    <span *ngIf="!avatarUrl" class="participant-avatar">ğŸ‘¤</span>
    <span class="participant-score-label">Mon score</span>
    <span class="participant-score-value">{{ totalScore }} / {{ totalQuestions }} point{{ totalQuestions > 1 ? 's' : '' }}</span>
  </div>
  <div class="participant-score-detail">
    <span *ngIf="personalScore.good" class="score-good">âœ… Bonne rÃ©ponse !</span>
    <span *ngIf="personalScore.bad" class="score-bad">âŒ Mauvaise rÃ©ponse</span>
    <span *ngIf="personalScore.none" class="score-none">â° Non rÃ©pondu</span>
  </div>
  <h2 class="quiz-question-title">{{ currentQuestion.text }}</h2>
  <div class="quiz-timer-container" *ngIf="step === 'question'">
    <div class="quiz-timer-bar-bg">
      <div class="quiz-timer-bar" [style.width]="timerPercent + '%'" [class.quiz-timer-bar-end]="!timerActive"></div>
    </div>
    <div class="quiz-timer-count">â° {{ timer }} s</div>
  </div>
  <div *ngIf="step === 'result'" class="quiz-vote-closed">â³ Vote clos pour cette question</div>
  <!-- Score rÃ©sumÃ© dÃ©placÃ© uniquement dans la banniÃ¨re -->
  <ul class="quiz-options-list">
    <li *ngFor="let option of currentQuestion.options; let i = index">
      <button
        class="quiz-option-btn"
        (click)="selectAnswer(i)"
        [disabled]="(selectedAnswerIndex !== null && selectedAnswerIndex !== -1) || !timerActive || step === 'result'"
        [class.quiz-option-correct]="step === 'result' && i === currentQuestion.correctIndex"
        [class.quiz-option-incorrect]="step === 'result' && selectedAnswerIndex === i && i !== currentQuestion.correctIndex"
        [class.quiz-option-selected]="selectedAnswerIndex === i && step === 'question'"
        [class.quiz-option-noanswer]="step === 'result' && selectedAnswerIndex === -1"
      >
        <span *ngIf="selectedAnswerIndex === i && step === 'question'" class="quiz-option-selected-icon">ğŸ‘‰</span>
        {{ option }}
        <span *ngIf="step === 'result' && i === currentQuestion.correctIndex" style="margin-left:1em; color:#43a047;">âœ”ï¸</span>
      </button>
    </li>
  </ul>
  <div *ngIf="step === 'result'" class="quiz-personal-score">
    <span *ngIf="personalScore.good">âœ… Bonne rÃ©ponse !</span>
    <span *ngIf="personalScore.bad">âŒ Mauvaise rÃ©ponse</span>
    <span *ngIf="personalScore.none">â° Non rÃ©pondu</span>
  </div>
  <div style="color: #d32f2f; font-size: 0.95em; margin-bottom: 1em;">
    [DEBUG] step: {{ step }} | timerActive: {{ timerActive }} | selectedAnswerIndex: {{ selectedAnswerIndex }}
  </div>
  <button class="quiz-next-btn" (click)="nextQuestion()" [disabled]="selectedAnswerIndex === null || step === 'result'">Suivant</button>
</div>

<div *ngIf="quizFinished" class="quiz-finished-container">
  <h2>Quiz terminÃ© !</h2>
  <div class="participant-score-banner">
    <img *ngIf="avatarUrl" [src]="avatarUrl" alt="avatar" class="participant-avatar" />
    <span *ngIf="!avatarUrl" class="participant-avatar">ğŸ‘¤</span>
    <span class="participant-score-label">Mon score</span>
    <span class="participant-score-value">{{ totalScore }} / {{ totalQuestions }} point{{ totalQuestions > 1 ? 's' : '' }}</span>
  </div>
  <div class="participant-score-detail">
    <span *ngIf="personalScore.good" class="score-good">âœ… Bonne rÃ©ponse !</span>
    <span *ngIf="personalScore.bad" class="score-bad">âŒ Mauvaise rÃ©ponse</span>
    <span *ngIf="personalScore.none" class="score-none">â° Non rÃ©pondu</span>
  </div>
  <h3 style="margin-top:2em;">Classement final</h3>
  <ol class="joueur-leaderboard-list" style="list-style:none; padding:0; max-width:400px; margin:2em auto 0 auto;">
    <li *ngFor="let user of leaderboard; let i = index" class="joueur-leaderboard-item" style="display:flex;align-items:center;gap:1em;margin-bottom:1em;">
      <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="avatar" width="38" height="38" style="border-radius:50%;border:2px solid #1976d2;" />
      <span class="joueur-leaderboard-rank" style="font-size:1.2em; font-weight:bold; color:#e65100; min-width:2em; text-align:center;">{{ i + 1 }}</span>
      <span style="font-weight:bold;">{{ user.name }}</span>
      <span style="margin-left:auto; font-size:1.1em; color:#1976d2; font-weight:bold;">{{ user.score }} / {{ totalQuestions }} pts</span>
    </li>
  </ol>
</div>
