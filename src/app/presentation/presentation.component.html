<!-- Modal de restauration de partie -->
<div *ngIf="showRestoreDialog" class="restore-modal-backdrop">
  <div class="restore-modal">
    <div class="restore-header">
      <h2>ğŸ”„ Partie en cours dÃ©tectÃ©e</h2>
    </div>
    <div class="restore-body">
      <p>Une partie Ã©tait en cours avant la fermeture de la page.</p>
      <p>Souhaitez-vous :</p>
      <div class="restore-actions">
        <button 
          class="restore-btn continue" 
          [disabled]="!buttonsEnabled"
          [class.disabled]="!buttonsEnabled"
          (click)="onRestoreGame()">
          <span class="btn-icon">ğŸ”„</span>
          <span>Reprendre la partie</span>
        </button>
        <button 
          class="restore-btn new-game" 
          [disabled]="!buttonsEnabled"
          [class.disabled]="!buttonsEnabled"
          (click)="onStartNewGame()">
          <span class="btn-icon">ğŸ†•</span>
          <span>Nouvelle partie</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- DIAGNOSTIC : Bloc ultra-visible si aucune Ã©tape reconnue
<div *ngIf="!step || (step !== 'lobby' && step !== 'waiting' && step !== 'question' && step !== 'result' && step !== 'end')" style="background:#d32f2f;color:#fff;font-size:1.5em;padding:2em 2em;border-r  </div>

</div>

<!-- Modal pour la photo de groupe -<!-- Barre d'administration admin -->
<div class="admin-bar">
  <div class="admin-info">
    <span class="admin-title">ğŸ‘¨â€ğŸ’¼ Administration</span>
    <span class="session-info">
      Session : {{ getRemainingTime() }}
    </span>
  </div>
  <div class="admin-actions">
    <button class="admin-btn extend" (click)="extendSession()" title="Prolonger la session de 4 heures">
      â° Prolonger
    </button>
    <button class="admin-btn logout" (click)="logout()" title="Se dÃ©connecter">
      ğŸšª DÃ©connexion
    </button>
  </div>
</div>

<!-- DIAGNOSTIC : Bloc ultra-visible si aucune Ã©tape reconnue -->
<div *ngIf="!step || (step !== 'lobby' && step !== 'waiting' && step !== 'question' && step !== 'result' && step !== 'end')" style="background:#d32f2f;color:#fff;font-size:1.5em;padding:2em 2em;border-radius:8px;margin:1em;text-align:center;">
  ğŸš¨ ERREUR : Ã‰tape inconnue "{{ step }}" - VÃ©rifiez la logique de navigation
</div>

<!-- Modal pour la photo de groupe -->
<div *ngIf="showCameraModal" class="camera-modal-overlay" [@stepTransition]>
  <div class="camera-modal">
    <div class="camera-header">
      <h3>ğŸ“· Photo de groupe - Promotion 2025</h3>
      <button class="camera-close-btn" (click)="stopCamera()">âœ•</button>
    </div>

    <div class="camera-container">
      <video id="cameraVideo" class="camera-video" autoplay muted playsinline></video>

      <!-- Overlay de prÃ©visualisation -->
      <div class="camera-overlay">
        <div class="overlay-promotion">
          <div class="overlay-title">ğŸ† Quiz Promotion 2025</div>
          <div class="overlay-date">{{ getCurrentDate() }}</div>
          <div class="overlay-corners">
            <span class="corner-left">ğŸŒŸ</span>
            <span class="corner-right">ğŸŒŸ</span>
          </div>
        </div>
      </div>
    </div>

    <div class="camera-controls">
      <button *ngIf="!photoTaken" class="camera-btn camera-take-btn" (click)="takeGroupPhoto()" [disabled]="!cameraReady">
      <!-- Indicateur d'Ã©tat de la camÃ©ra -->
      <div class="camera-status" *ngIf="cameraActive && !photoTaken">
        <span class="status-indicator" [class.ready]="cameraReady">
          {{ cameraReady ? 'âœ… CamÃ©ra prÃªte' : 'â³ PrÃ©paration...' }}
        </span>
      </div>
      
        ğŸ“· Prendre la photo
      </button>
      <div *ngIf="photoTaken" class="photo-success">
        âœ… Photo prise avec succÃ¨s ! TÃ©lÃ©chargement en cours...
      </div>
      <button class="camera-btn camera-cancel-btn" (click)="stopCamera()">
        Annuler
      </button>
    </div>
  </div>
</div>

<!-- DEBUG : bouton pour forcer l'Ã©tape 'question'
<button style="position:fixed;top:10px;right:10px;z-index:9999;background:#1976d2;color:#fff;padding:0.5em 1em;border-radius:6px;font-size:1em;" (click)="quizService.setStep('question')">[DEBUG] Forcer Ã©tape QUESTION</button>
-->

<!-- DEBUG: Affichage d'urgence si aucune Ã©tape n'est reconnue
<div *ngIf="!step || (step !== 'lobby' && step !== 'waiting' && step !== 'question' && step !== 'result' && step !== 'end')" style="background:#d32f2f;color:#fff;padding:2em;border-radius:16px;margin:2em;text-align:center;box-shadow:0 2px 24px #d32f2f88;z-index:99999;position:relative;">
  <b>âš ï¸ Aucun Ã©cran d'Ã©tape affichÃ©</b><br>
  <span style="font-size:1.1em;color:#ffe082;">La variable <b>step</b> n'est pas reconnue ou n'est pas initialisÃ©e.</span><br>
  <span style="font-size:1.2em;color:#fff !important;">step = {{step}}</span>
  <span style="font-size:1.1em;color:#fff !important;">VÃ©rifiez la synchronisation et l'initialisation dans le TypeScript.</span>
</div>
-->
<!-- Ã‰cran maÃ®tre du jeu classique

<div class="maitre-banner">
  <div class="maitre-banner-content">
    <span class="maitre-banner-icon">ğŸ¤</span>
    <span class="maitre-banner-title">Ã‰CRAN MAÃTRE DU JEU</span>
  </div>
  <div class="maitre-message">Vous Ãªtes sur lâ€™interface <b>MAÃTRE DU JEU</b>.</div>
</div>

<h1 class="presentation-title">Quiz - Ã‰cran de prÃ©sentation</h1>-->

<div class="presentation-main">

<!-- LOBBY : QR code + liste des inscrits + bouton dÃ©marrer -->
<div *ngIf="step === 'lobby'" class="maitre-step-banner lobby step-block" [@stepTransition]>
  <div class="banner-img"><div class="step-header">
    <!-- <span class="step-icon">ğŸŸ¢</span> -->
    <span class="step-title">&nbsp;</span>
  </div>
  <!-- <div class="step-desc">QR code, liste des inscrits, bouton dÃ©marrer</div>
  <div class="maitre-debug">step = {{step}}</div> -->
  <h2 class="step-h2">Scan to join and enjoy the game</h2>
  </div>
  <div class="bg-qr">
    <qrcode [qrdata]="windowLocation + '/login'" [width]="200" [errorCorrectionLevel]="'M'"></qrcode>
    <div class="qr-text-info">
      <p class="join-url">Or visit: <strong>{{windowLocation}}/login</strong></p>
    </div>
  </div>


<div class="container-question">
  <h3 class="step-h3">Registered players</h3>
  <br/>
  <ul class="step-list" [@listAnimation]>
    <li *ngFor="let user of participants; trackBy: trackByQuestionId" class="step-list-item">
      <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="avatar" width="32" height="32" class="step-avatar" />
      {{ user.name }}
    </li>
  </ul>
  <button class="step-btn" (click)="launchGame()" [disabled]="participants.length === 0">Close registration</button>
  <button class="step-btn" (click)="restartGame()">Reset</button>
  <div *ngIf="participants.length === 0" class="step-waiting">Waiting for players...</div>
</div>
</div>

<!-- WAITING : attente avant la premiÃ¨re question -->
<div *ngIf="step === 'waiting'" class="maitre-step-banner waiting step-block" [@stepTransition]>
  <div class="step-header">
    <!-- <span class="step-icon">â³</span>
    <span class="step-title">[Ã‰TAPE MAÃTRE] ATTENTE</span> -->
  </div>
  <!-- <div class="step-desc">Attente avant la premiÃ¨re question</div>
  <div class="maitre-debug">step = {{step}}</div> -->
  <div class="container-question">
  <h2 class="step-h2">Quiz is about to start!</h2>
  <h3 class="step-h3">Registered players</h3>
  <br/>
    <ul class="step-list" [@listAnimation]>
      <li *ngFor="let user of participants; trackBy: trackByQuestionId" class="step-list-item">
        <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="avatar" width="32" height="32" class="step-avatar" />
        {{ user.name }}
      </li>
    </ul>

  <div class="step-total">Total : {{ participants.length }} player(s)</div>
  <br/>
  <button class="step-btn" (click)="startFirstQuestion()">Start the quiz</button>
  <button class="step-btn" (click)="restartGame()">Reset</button>
  </div>
  </div>
</div>
<!-- QUESTION : question, rÃ©ponses, timer -->
<div *ngIf="step === 'question' && currentQuestion" class="maitre-step-banner question step-block" [@stepTransition]>
  <div class="step-header">
    <!-- <span class="step-icon">â“</span>
    <span class="step-title">[Ã‰TAPE MAÃTRE] QUESTION</span> -->
  </div>
  <!-- <div class="step-desc">Question, rÃ©ponses, timer</div>
  <div class="maitre-debug">step = {{step}} | currentQuestion = {{currentQuestion.text}}</div>
  <button class="step-btn" (click)="restartGame()">Tout rÃ©initialiser</button>
  <h2 class="step-h2">Question</h2>-->
  <div class="question-illustration" [@imageAnimation]>
    <!-- Structure avec ngFor pour forcer la recrÃ©ation complÃ¨te -->
    <ng-container *ngFor="let q of [currentQuestion]; trackBy: trackByQuestionId">
      <!-- Image avec transition et dimensions prÃ©servÃ©es - cachÃ©e si hideImages est true -->
      <img
        *ngIf="q?.imageUrl && imageLoaded && !hideImages"
        [src]="q.imageUrl"
        alt="Illustration question"
        style="width:100%;height:100%;object-fit:cover;border-radius:18px;transition:opacity 0.4s ease-in-out;"
        class="question-image-loaded"
        [@imageAnimation]
      />
      <!-- Placeholder pendant chargement - mÃªme dimensions - cachÃ© si hideImages est true -->
      <div
        *ngIf="q?.imageUrl && !imageLoaded && !hideImages"
        style="width:100%;height:100%;background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);background-size: 20px 20px;background-position: 0 0, 0 10px, 10px -10px, -10px 0px;border-radius:18px;display:flex;align-items:center;justify-content:center;color:#666;"
        class="question-image-loading"
      >
        <div style="background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 8px; font-weight: 500;">
          â³ Chargement de l'image...
        </div>
      </div>
      <!-- Image cachÃ©e pour prÃ©chargement avec clÃ© unique - pas affectÃ©e par hideImages -->
      <img
        *ngIf="q?.imageUrl && !hideImages"
        [src]="q.imageUrl"
        alt="PrÃ©chargement"
        style="position: absolute; visibility: hidden; width: 1px; height: 1px;"
        (load)="onImageLoaded()"
        (error)="onImageError()"
      />
    </ng-container>
  </div>
  <h3 class="step-h3">{{ currentQuestion.text }}</h3>
  <div class="container-question">
  <div class="timer step-timer" [@stepTransition]>
    <div class="timer-bar-container">
      <div class="timer-bar" [ngStyle]="{width: (timerValue / timerMax * 100) + '%'}"></div>
      <span class="timer-bar-label">{{ timerValue }}s</span>
    </div>
    <button class="step-btn" (click)="forceEndTimer()">Skip</button>
  </div>
   <ul *ngIf="currentQuestion && currentQuestion.options" class="step-list" [@listAnimation]>
    <li *ngFor="let option of currentQuestion.options; let i = index; trackBy: trackByQuestionId" class="step-list-item step-option" style="pointer-events: none; cursor: default;">
      <span>{{ option }}</span>
      <span *ngIf="currentQuestion && i === currentQuestion.correctIndex" class="step-correct">&nbsp;</span>
    </li>
  </ul>
  </div>

  <div *ngIf="voters && voters.length > 0" class="step-voters" [@stepTransition]>
    <h4 class="step-h4">Already answered :</h4>
    <ul class="step-voters-list" [@listAnimation]>
      <li *ngFor="let voter of voters; trackBy: trackByQuestionId" class="step-voter-item">
        {{ voter }}
      </li>
    </ul>
    <div class="step-voters-total">{{ voters.length }} player(s) have voted</div>
  </div>
</div>


<!-- RESULT : bonne rÃ©ponse, stats, bouton question suivante, bouton reset complet -->
<div *ngIf="step === 'result'" class="maitre-step-banner result step-block" [@stepTransition]>
  <div class="step-header">
    <!--  <span class="step-icon">ğŸ</span>
    <span class="step-title">[Ã‰TAPE MAÃTRE] RESULT</span> -->
  </div>
  <!-- <div *ngIf="answersCount.length === 0 || totalAnswers === 0" class="maitre-no-result step-no-result">
    <b>âš ï¸ Aucun rÃ©sultat Ã  afficher pour cette question</b><br>
    <span>Aucune rÃ©ponse enregistrÃ©e dans SQLite.<br>VÃ©rifiez que les participants ont bien rÃ©pondu.</span>
    <br>
    <span>answersCount = {{answersCount}}</span>
    <span>totalAnswers = {{totalAnswers}}</span>
  </div>
  <button class="step-btn" (click)="restartGame()">ğŸ§¹ Tout rÃ©initialiser</button> -->
  <div *ngIf="!currentQuestion" class="maitre-no-question step-no-question">Aucune question courante.</div>
  <ng-container *ngIf="currentQuestion">
    <!--  <h2 class="step-h2">RÃ©sultat</h2> -->
    <div class="question-illustration" [@imageAnimation]>
      <!-- Structure avec ngFor pour forcer la recrÃ©ation complÃ¨te -->
      <ng-container *ngFor="let q of [currentQuestion]; trackBy: trackByQuestionId">
        <!-- Image de rÃ©sultat avec dimensions prÃ©servÃ©es - cachÃ©e si hideImages est true -->
        <img
          *ngIf="q?.imageUrlResult && resultImageLoaded && !hideImages"
          [src]="q.imageUrlResult"
          alt="Illustration rÃ©sultat"
          style="width:100%;height:100%;object-fit:cover;border-radius:18px;transition:opacity 0.4s ease-in-out;"
          class="result-image-loaded"
          [@imageAnimation]
        />
        <!-- Placeholder pendant chargement - cachÃ© si hideImages est true -->
        <div
          *ngIf="q?.imageUrlResult && !resultImageLoaded && !hideImages"
          style="width:100%;height:100%;background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);background-size: 20px 20px;background-position: 0 0, 0 10px, 10px -10px, -10px 0px;border-radius:18px;display:flex;align-items:center;justify-content:center;color:#666;"
          class="result-image-loading"
        >
          <div style="background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 8px; font-weight: 500;">
            â³ Chargement du rÃ©sultat...
          </div>
        </div>
        <!-- Image cachÃ©e pour prÃ©chargement avec clÃ© unique - pas affectÃ©e par hideImages -->
        <img
          *ngIf="q?.imageUrlResult && !hideImages"
          [src]="q.imageUrlResult"
          alt="PrÃ©chargement rÃ©sultat"
          style="position: absolute; visibility: hidden; width: 1px; height: 1px;"
          (load)="onResultImageLoaded()"
          (error)="onResultImageError()"
        />
      </ng-container>
    </div>
    <div class="container-question">
    <div class="step-stats" [@stepTransition]>
      <span class="step-good">
        Correct answer :
        <b>
          {{ (currentQuestion.options && currentQuestion.correctIndex !== undefined && currentQuestion.options[currentQuestion.correctIndex] !== undefined)
              ? currentQuestion.options[currentQuestion.correctIndex]
              : 'â€”' }}
        </b>
      </span>
      <br>
      <span class="step-total-good">Number of correct answers : {{ totalGood }}</span>
      <br>
      <span class="step-total-bad">Number of wrong answers : {{ totalBad }}</span>
    </div>

    <!-- CLASSEMENT PROVISOIRE -->
    <div class="step-leaderboard-block" [@stepTransition]>
      <h3 class="step-leaderboard-title">Ranking</h3>
      <ol class="step-leaderboard-list" [@listAnimation]>
        <li class="step-leaderboard-item" *ngFor="let user of leaderboard; let i = index; trackBy: trackByQuestionId">
          <span class="step-leaderboard-rank">{{ i + 1 }}</span>
          <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="avatar" width="28" height="28" class="step-avatar" />
          <span class="step-leaderboard-name">{{ user.name }}</span>
          <span class="step-leaderboard-score">{{ user.score }} / {{ quizService.getQuestions().length }} pts</span>
          <span *ngIf="user.totalTime > 0" class="step-leaderboard-time">â±ï¸ {{ formatTime(getTotalGoodAnswersTime(user.id)) }} (bonnes rÃ©ponses)</span>
        </li>
      </ol>
    </div>

    <button class="step-btn step-next-btn" (click)="nextQuestion()" *ngIf="currentIndex < (quizService.getQuestions().length - 1)" [@stepTransition]>âœ  &nbsp;Next question</button>
    <button class="step-btn step-end-btn" (click)="endGame()" *ngIf="canShowEndButton()" [@stepTransition]>Close quiz & show ranking</button>
  </div>
  </ng-container>

</div>

<!-- DEBUG : bouton pour forcer lâ€™Ã©tape 'question'
<button style="position:fixed;top:10px;right:10px;z-index:9999;background:#1976d2;color:#fff;padding:0.5em 1em;border-radius:6px;font-size:1em;" (click)="quizService.setStep('question')">[DEBUG] Forcer Ã©tape QUESTION</button>

  <!-- END : classement final -->
  <div *ngIf="step === 'end'" class="maitre-step-banner end step-block" [@stepTransition]>
  <div class="banner-img"><div class="step-header">
    <!-- <span class="step-icon">ğŸŸ¢</span> -->
    <span class="step-title">&nbsp;</span>
  </div>
  <h2 class="step-h2">You've completed the test !</h2>
  </div>
  <div>
    <div class="container-question">
    <h3 class="step-h3">Final ranking</h3>
    <ol class="step-leaderboard-list" [@listAnimation]>
      <li class="step-leaderboard-item" *ngFor="let user of leaderboard; let i = index; trackBy: trackByQuestionId">
        <span class="step-leaderboard-rank">{{ i + 1 }}</span>
        <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" alt="avatar" width="32" height="32" class="step-avatar" />
        <span class="step-leaderboard-name">{{ user.name }}</span> â€” <span class="step-leaderboard-score">{{ user.score }} / {{ quizService.getQuestions().length }} pts</span>
        <span *ngIf="user.totalTime > 0" class="step-leaderboard-time">â±ï¸ {{ formatTime(getTotalGoodAnswersTime(user.id)) }} (bonnes rÃ©ponses)</span>
      </li>
    </ol>

    <div class="step-final-buttons">
      <button class="step-btn step-capture-btn" (click)="captureLeaderboard()" [@stepTransition]>
        ğŸ“¸ Capture scores
      </button>
      <button class="step-btn step-camera-btn" (click)="startCamera()" [@stepTransition]>
        ğŸ“· Photo de groupe
      </button>
      <button class="step-btn" (click)="restartGame()" [@stepTransition]>Reset the game</button>
    </div>
  </div>

</div>

<div class="global-reset-btn" (click)="restartGame()" title="RÃ©initialiser complÃ¨tement le quiz (participants, scores, Ã©tat)">
  ğŸ”„
</div>

</div>
